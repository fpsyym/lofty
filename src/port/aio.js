/*! Lofty v0.1 beta AIO http://lofty.fangdeng.org/ MIT*/
(function(b){if(!b.lofty){var g={},a=function(e,d,f){if(!g[e]){f||(f=d,d=[]);e=g[e]={id:e,deps:d,factory:f};if("function"===typeof e.factory){d=[];f=e.deps;for(var b=0,l=f.length;b<l;b++)d.push(h(f[b]));e.exports=e.factory.apply(a,d)}else e.exports=e.factory;delete e.factory}},h=function(e){return(e=g[e])?e.exports:null};a.version="0.1";a.cache={kernel:g};a("global",b);a("require",function(){return h});b.lofty=a}})(this);
lofty("lang",function(){var b={}.toString,g=Array.prototype,a={isFunction:function(a){return"[object Function]"===b.call(a)},isArray:Array.isArray||function(a){return"[object Array]"===b.call(a)},isString:function(a){return"string"===typeof a},forEach:g.forEach?function(a,e,d){a.forEach(e,d)}:function(a,e,d){for(var f=0,b=a.length;f<b;f++)e.call(d,a[f],f,a)},map:g.map?function(a,e,d){return a.map(e,d)}:function(b,e,d){var f=[];a.forEach(b,function(a,b,m){f.push(e.call(d,a,b,m))});return f},indexOf:g.indexOf?
function(a,e){return a.indexOf(e)}:function(a,e){for(var d=0,f=a.length;d<f;d++)if(a[d]===e)return d;return-1}};return a});lofty("event",function(){var b=this.cache.events={},g=[].slice;return{on:function(a,g){(b[a]||(b[a]=[])).push(g)},emit:function(a){var h=g.call(arguments,1),e=b[a],d,f=0;if(e)for(;d=e[f++];)d.apply(null,h)}}});
lofty("config",["lang"],function(b){var g=this.cache,a=g.config={},h=g.configRules={},g={addRule:function(a,d){h[a]={rule:d,keys:[]};return this},addItem:function(a,d){h[d]&&h[d].keys.push(a);return this}};g.addRule("object",function(a,d,f){if(a){for(var b in f)a[b]=f[b];return!0}return!1}).addRule("array",function(a,d,b){a?a.push(b):this[d]=[b];return!0});this.config=function(e){for(var d in e){var f=e[d],g=a[d],l=d,m=f,j=!1,c=void 0,n=void 0;for(n in h)if(j)break;else c=h[n],j=-1<b.indexOf(c.keys,
l)&&c.rule.call(a,g,l,m);j||(a[d]=f)}};return g});lofty("alias",["config","event"],function(b,g){var a=this.cache.config;b.addItem("alias","object");return function(b){var e=a.alias,d;if(e&&(d=e[b.id]))b.id=d;g.emit("alias",b)}});
lofty("module",["global","lang","event","alias"],function(b,g,a,h){var e=[],d=0,f=this.cache.modules={},k={get:function(c){c={id:c};h(c);return f[c.id]},has:function(c){return k.get(c)||m[c]?!0:!1},hasDefine:function(c){return f[c]?!0:!1},isAnon:function(c){return""===c.id},save:function(c){f[c._id||c.id]=c},autocompile:function(c){k.isAnon(c)&&k.compile(c)},compile:function(c){try{if(g.isFunction(c.factory)){var d=[],b=c.deps;g.isArray(b)&&g.forEach(b,function(a){var b;a=(b=m[a])?b(c):k.require(a,
c);d.push(a)});var e=c.factory.apply(null,d);void 0!==e?c.exports=e:c.entity&&c.entity.exports&&(c.exports=c.entity.exports);c.entity&&delete c.entity}else void 0!==c.factory&&(c.exports=c.factory);a.emit("compiled",c)}catch(f){a.emit("compileFail",f,c)}},require:function(c){var b=k.get(c);b?(b.visits||(b.visits++,k.compile(b)),a.emit("required",b),c=b.exports):(a.emit("requireFail",{id:c}),c=null);return c}},l=function(c,a,b){this.id=c;this.deps=a||[];this.factory=b;this.exports={};this.visits=0;
""===c&&(c="__!_lofty_anonymous_"+d,d++,this._id=c)},m={require:function(){function c(c){return k.require(c)}a.emit("makeRequire",c);return c},exports:function(c){return c.exports},module:function(c){c.entity={id:c.id,exports:c.exports};return c.entity}},j=b.define;this.noConflict=function(){b.define=j};this.define=function(c,b,d){var f;f=arguments.length;1===f?(d=c,c=""):2===f&&(d=b,b=e,g.isString(c)||(b=c,c=""));if(k.hasDefine(c))return a.emit("existed",{id:c}),null;f=new l(c,b,d);a.emit("define",
f);k.save(f);k.autocompile(f)};b.define=this.define;return k});
lofty("loader",["global"],function(b){var g=this.cache.config,a=b.document,h=/\.css(?:\?|$)/,e=/loaded|complete|undefined/,d=536>1*b.navigator.userAgent.replace(/.*AppleWebKit\/(\d+)\..*/,"$1"),f=a&&(a.head||a.getElementsByTagName("head")[0]||a.documentElement),k=a.getElementsByTagName("base")[0],l=function(a,b){a.onerror=function(){a.onload=a.onreadystatechange=a.onerror=null;a=void 0;b&&b()}};return function(m,j){var c;if(h.test(m)){var n=c=a.createElement("link");if(d||!("onload"in n)){var q=a.createElement("img");
q.onerror=function(){j();q.onerror=null;q=void 0};q.src=m}else n.onload=n.onreadystatechange=function(){e.test(n.readyState)&&(n.onload=n.onreadystatechange=n.onerror=null,n=void 0,j&&j())},l(n,j);c.rel="stylesheet";c.href=m}else{var p=c=a.createElement("script");p.onload=p.onreadystatechange=function(c){c=c||b.event;if("load"===c.type||e.test(p.readyState))p.onload=p.onreadystatechange=p.onerror=null,g.debug||f.removeChild(p),p=void 0,j&&j()};l(p,j);c.async=!0;c.src=m}g.charset&&(c.charset=g.charset);
k?f.insertBefore(c,k):f.appendChild(c)}});
lofty("id2url",["global","event","config","alias"],function(b,g,a,h){var e=this.cache.config,d=/\?|\.(?:css|js)$|\/$/,f=/^https?:\/\//,k=(new Date).getTime();b=b.document.getElementsByTagName("script");b=b[b.length-1];b=(b.hasAttribute?b.src:b.getAttribute("src",4)).match(/([\w]+)\:\/\/([\w|\.|\:]+)\//i);e.baseUrl=b[0];a.addItem("resolve","array").addItem("stamp","object");return function(a){h(a);var b=e.resolve,j;if(b)for(var c=0,n=b.length;c<n&&!(j=b[c](a.id),j!==a.id);c++);a.url=j?j:a.id;f.test(a.url)||
(a.url=e.baseUrl+a.url);!d.test(a.url)&&(a.url+=".js");b=e.hasStamp?k:null;if(j=e.stamp)for(var q in j)if(RegExp(q).test(a.id)){b=j[q];break}b&&(a.url+="?lofty.stamp="+b);g.emit("id2url",a)}});
lofty("request",["global","event","loader","id2url"],function(b,g,a,h){var e=this.cache,d=e.config,f=e.assets={};d.loadTimeout=1E4;var k=function(a,d){if(!a.timeout){b.clearTimeout(a.timer);var f,c;d?(a.status=2,c=a.callQueue):(a.status=-1,c=a.errorQueue);for(;f=c.shift();)f()}};return function(b,e,j){var c;b={id:b};h(b);c=f[b.url]||(f[b.url]=b);2===c.status?e&&e():(c.callQueue?c.callQueue.push(e):c.callQueue=[e],c.errorQueue?c.errorQueue.push(j):c.errorQueue=[j],1!==c.status&&(c.status=1,c.timer=
setTimeout(function(){c.timeout=!0;k(c,!1);g.emit("requestTimeout",c)},d.loadTimeout),a(c.url,function(){k(c,!0)})))}});
lofty("deferred",function(){var b=function(){},g=function(a){var g=this,e=[],d=0,f=0;a=a||1;var k=function(){g.then=!f?function(a){a&&a()}:function(a,b){b&&b()};k=b;l(!f?0:1);l=b;e=[]},l=function(a){for(var b,c=0;b=e[c++];)(b=b[a])&&b()};this.then=function(a,b){e.push([a,b])};this.resolve=function(){d++;d+f===a&&k()};this.reject=function(){f++;d+f===a&&k()}};return function(){for(var a=new g(arguments.length),b,e=0;b=arguments[e++];)b(a);return a}});
lofty("use",["lang","event","module","request","deferred"],function(b,g,a,h,e){var d={realize:function(f,e){b.isArray(f)||(f=[f]);d.load(f,function(){var d=b.map(f,function(b){return a.require(b)});e&&e.apply(null,d)})},load:function(f,e){var g=[];b.forEach(f,function(b){a.has(b)||g.push(b)});g.length?d.fetch(g,e):e()},fetch:function(f,g){d.get(f,function(){e.apply(null,b.map(f,function(b){return function(e){var f=a.get(b);f?d.load(f.deps,function(){e.resolve()}):e.resolve()}})).then(g)})},get:function(d,
g,l){e.apply(null,b.map(d,function(b){return function(d){a.has(b)?d.resolve():h(b,function(){d.resolve()},function(){d.reject()})}})).then(g,l)}};g.on("makeRequire",function(a){a.use=function(a,b,e){d.realize(a,b,e)}});return d});lofty("amd",["module","use"],function(b,g){var a=this.cache.config;a.amd=!0;b.autocompile=function(h){b.isAnon(h)&&(a.amd?g.load(h.deps,function(){b.compile(h)}):b.compile(h))}});
lofty("debug",["global","config","console","request","require"],function(b,g,a,h,e){var d=this,f=this.log=function(){};g.addRule("debug",function(g,l,m){d.log=m?b.console?function(a,c){b.console[c||"log"](a)}:function(b,c){a?a(b,c):h&&h("lofty/kernel/console",function(){a||(a=e("console"));a(b,c)})}:f;this[l]=m;return!0}).addItem("debug","debug")});
lofty("alicn",["global","event","config"],function(b,g,a){var h=/\.css(?:\?|$)/,e=/([a-z])([A-Z])/g;this.config({hasStamp:!0,resolve:function(a){a=a.replace(e,function(a,b,c){return b+"-"+c}).toLowerCase();var b=a.split("/"),g=b[0],l=h.test(a)?"css/":"js/";switch(g){case "lofty":case "avid":a="/fdevlib/"+l+a;break;case "sys":a="/sys/"+l+b.slice(1).join("/")}return a},debug:function(){var a=!1;0<b.location.href.indexOf("lofty.debug=true")&&(a=!0);return a}()});this.appframe=function(d){d=b[d]={define:this.define,
log:this.log,config:this.config,on:g.on};d.config.addRule=a.addRule;d.config.addItem=a.addItem}});
