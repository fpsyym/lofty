/*! Lofty v0.1 beta Classic http://lofty.fangdeng.org/ MIT*/
(function(d){if(!d.lofty){var g={},a=function(e,c,f){if(!g[e]){f||(f=c,c=[]);e=g[e]={id:e,deps:c,factory:f};if("function"===typeof e.factory){c=[];f=e.deps;for(var h=0,l=f.length;h<l;h++)c.push(j(f[h]));e.exports=e.factory.apply(a,c)}else e.exports=e.factory;delete e.factory}},j=function(e){return(e=g[e])?e.exports:null};a.version="0.1";a.cache={kernel:g};a("global",d);a("require",function(){return j});d.lofty=a}})(this);
lofty("lang",function(){var d={}.toString,g=Array.prototype,a={isFunction:function(a){return"[object Function]"===d.call(a)},isArray:Array.isArray||function(a){return"[object Array]"===d.call(a)},isString:function(a){return"string"===typeof a},forEach:g.forEach?function(a,e,c){a.forEach(e,c)}:function(a,e,c){for(var f=0,h=a.length;f<h;f++)e.call(c,a[f],f,a)},map:g.map?function(a,e,c){return a.map(e,c)}:function(d,e,c){var f=[];a.forEach(d,function(a,l,m){f.push(e.call(c,a,l,m))});return f},indexOf:g.indexOf?
function(a,e){return a.indexOf(e)}:function(a,e){for(var c=0,f=a.length;c<f;c++)if(a[c]===e)return c;return-1}};return a});lofty("event",function(){var d=this.cache.events={},g=[].slice;return{on:function(a,g){(d[a]||(d[a]=[])).push(g)},emit:function(a){var j=g.call(arguments,1),e=d[a],c,f=0;if(e)for(;c=e[f++];)c.apply(null,j)}}});
lofty("config",["lang"],function(d){var g=this.cache,a=g.config={},j=g.configRules={},g={addRule:function(a,c){j[a]={rule:c,keys:[]};return this},addItem:function(a,c){j[c]&&j[c].keys.push(a);return this}};g.addRule("object",function(a,c,f){if(a){for(var d in f)a[d]=f[d];return!0}return!1}).addRule("array",function(a,c,f){a?a.push(f):this[c]=[f];return!0});this.config=function(e){for(var c in e){var f=e[c],h=a[c],l=c,m=f,k=!1,b=void 0,g=void 0;for(g in j)if(k)break;else b=j[g],k=-1<d.indexOf(b.keys,
l)&&b.rule.call(a,h,l,m);k||(a[c]=f)}};return g});lofty("alias",["config","event"],function(d,g){var a=this.cache.config;d.addItem("alias","object");return function(d){var e=a.alias,c;if(e&&(c=e[d.id]))d.id=c;g.emit("alias",d)}});
lofty("module",["global","lang","event","alias"],function(d,g,a,j){var e=[],c=0,f=this.cache.modules={},h={get:function(b){b={id:b};j(b);return f[b.id]},has:function(b){return h.get(b)||m[b]?!0:!1},hasDefine:function(b){return f[b]?!0:!1},isAnon:function(b){return""===b.id},save:function(b){f[b._id||b.id]=b},autocompile:function(b){h.isAnon(b)&&h.compile(b)},compile:function(b){try{if(g.isFunction(b.factory)){var c=[],f=b.deps;g.isArray(f)&&g.forEach(f,function(a){var f;a=(f=m[a])?f(b):h.require(a,
b);c.push(a)});var e=b.factory.apply(null,c);void 0!==e?b.exports=e:b.entity&&b.entity.exports&&(b.exports=b.entity.exports);b.entity&&delete b.entity}else void 0!==b.factory&&(b.exports=b.factory);a.emit("compiled",b)}catch(l){a.emit("compileFail",l,b)}},require:function(b){var c=h.get(b);c?(c.visits||(c.visits++,h.compile(c)),a.emit("required",c),b=c.exports):(a.emit("requireFail",{id:b}),b=null);return b}},l=function(b,a,f){this.id=b;this.deps=a||[];this.factory=f;this.exports={};this.visits=0;
""===b&&(b="__!_lofty_anonymous_"+c,c++,this._id=b)},m={require:function(){function b(b){return h.require(b)}a.emit("makeRequire",b);return b},exports:function(b){return b.exports},module:function(b){b.entity={id:b.id,exports:b.exports};return b.entity}},k=d.define;this.noConflict=function(){d.define=k};this.define=function(b,c,f){var d;d=arguments.length;1===d?(f=b,b=""):2===d&&(f=c,c=e,g.isString(b)||(c=b,b=""));if(h.hasDefine(b))return a.emit("existed",{id:b}),null;d=new l(b,c,f);a.emit("define",
d);h.save(d);h.autocompile(d)};d.define=this.define;return h});
lofty("loader",["global"],function(d){var g=this.cache.config,a=d.document,j=/\.css(?:\?|$)/,e=/loaded|complete|undefined/,c=536>1*d.navigator.userAgent.replace(/.*AppleWebKit\/(\d+)\..*/,"$1"),f=a&&(a.head||a.getElementsByTagName("head")[0]||a.documentElement),h=a.getElementsByTagName("base")[0],l=function(a,c){a.onerror=function(){a.onload=a.onreadystatechange=a.onerror=null;a=void 0;c&&c()}};return function(m,k){var b;if(j.test(m)){var n=b=a.createElement("link");if(c||!("onload"in n)){var q=a.createElement("img");
q.onerror=function(){k();q.onerror=null;q=void 0};q.src=m}else n.onload=n.onreadystatechange=function(){e.test(n.readyState)&&(n.onload=n.onreadystatechange=n.onerror=null,n=void 0,k&&k())},l(n,k);b.rel="stylesheet";b.href=m}else{var p=b=a.createElement("script");p.onload=p.onreadystatechange=function(b){b=b||d.event;if("load"===b.type||e.test(p.readyState))p.onload=p.onreadystatechange=p.onerror=null,g.debug||f.removeChild(p),p=void 0,k&&k()};l(p,k);b.async=!0;b.src=m}g.charset&&(b.charset=g.charset);
h?f.insertBefore(b,h):f.appendChild(b)}});
lofty("id2url",["global","event","config","alias"],function(d,g,a,j){var e=this.cache.config,c=/\?|\.(?:css|js)$|\/$/,f=/^https?:\/\//,h=(new Date).getTime();d=d.document.getElementsByTagName("script");d=d[d.length-1];d=(d.hasAttribute?d.src:d.getAttribute("src",4)).match(/([\w]+)\:\/\/([\w|\.|\:]+)\//i);e.baseUrl=d[0];a.addItem("resolve","array").addItem("stamp","object");return function(a){j(a);var d=e.resolve,k;if(d)for(var b=0,n=d.length;b<n&&!(k=d[b](a.id),k!==a.id);b++);a.url=k?k:a.id;f.test(a.url)||
(a.url=e.baseUrl+a.url);!c.test(a.url)&&(a.url+=".js");d=e.hasStamp?h:null;if(k=e.stamp)for(var q in k)if(RegExp(q).test(a.id)){d=k[q];break}d&&(a.url+="?lofty.stamp="+d);g.emit("id2url",a)}});
lofty("request",["global","event","loader","id2url"],function(d,g,a,j){var e=this.cache,c=e.config,f=e.assets={};c.loadTimeout=1E4;var h=function(a,c){if(!a.timeout){d.clearTimeout(a.timer);var f,b;c?(a.status=2,b=a.callQueue):(a.status=-1,b=a.errorQueue);for(;f=b.shift();)f()}};return function(d,e,k){var b;d={id:d};j(d);b=f[d.url]||(f[d.url]=d);2===b.status?e&&e():(b.callQueue?b.callQueue.push(e):b.callQueue=[e],b.errorQueue?b.errorQueue.push(k):b.errorQueue=[k],1!==b.status&&(b.status=1,b.timer=
setTimeout(function(){b.timeout=!0;h(b,!1);g.emit("requestTimeout",b)},c.loadTimeout),a(b.url,function(){h(b,!0)})))}});
lofty("deferred",function(){var d=function(){},g=function(a){var g=this,e=[],c=0,f=0;a=a||1;var h=function(){g.then=!f?function(a){a&&a()}:function(a,c){c&&c()};h=d;l(!f?0:1);l=d;e=[]},l=function(a){for(var c,b=0;c=e[b++];)(c=c[a])&&c()};this.then=function(a,c){e.push([a,c])};this.resolve=function(){c++;c+f===a&&h()};this.reject=function(){f++;c+f===a&&h()}};return function(){for(var a=new g(arguments.length),d,e=0;d=arguments[e++];)d(a);return a}});
lofty("use",["lang","event","module","request","deferred"],function(d,g,a,j,e){var c={realize:function(f,e){d.isArray(f)||(f=[f]);c.load(f,function(){var c=d.map(f,function(c){return a.require(c)});e&&e.apply(null,c)})},load:function(f,e){var g=[];d.forEach(f,function(c){a.has(c)||g.push(c)});g.length?c.fetch(g,e):e()},fetch:function(f,g){c.get(f,function(){e.apply(null,d.map(f,function(d){return function(f){var e=a.get(d);e?c.load(e.deps,function(){f.resolve()}):f.resolve()}})).then(g)})},get:function(c,
g,l){e.apply(null,d.map(c,function(c){return function(d){a.has(c)?d.resolve():j(c,function(){d.resolve()},function(){d.reject()})}})).then(g,l)}};g.on("makeRequire",function(a){a.use=function(a,d,e){c.realize(a,d,e)}});return c});
lofty("debug",["global","config","console","request","require"],function(d,g,a,j,e){var c=this,f=this.log=function(){};g.addRule("debug",function(g,l,m){c.log=m?d.console?function(a,c){d.console[c||"log"](a)}:function(c,b){a?a(c,b):j&&j("lofty/kernel/console",function(){a||(a=e("console"));a(c,b)})}:f;this[l]=m;return!0}).addItem("debug","debug")});
lofty("alicn",["global","event","config"],function(d,g,a){var j=/\.css(?:\?|$)/,e=/([a-z])([A-Z])/g;this.config({hasStamp:!0,resolve:function(a){a=a.replace(e,function(a,c,b){return c+"-"+b}).toLowerCase();var d=a.split("/"),g=d[0],l=j.test(a)?"css/":"js/";switch(g){case "lofty":case "avid":a="/fdevlib/"+l+a;break;case "sys":a="/sys/"+l+d.slice(1).join("/")}return a},debug:function(){var a=!1;0<d.location.href.indexOf("lofty.debug=true")&&(a=!0);return a}()});this.appframe=function(c){c=(d[c]={define:this.define,
log:this.log,config:this.config,on:g.on}).config;c.addRule=a.addRule;c.addItem=a.addItem}});
