/*! Lofty v0.1 beta Classic http://lofty.fangdeng.org/ MIT*/
(function(d){if(!d.lofty){var g={},a=function(e,h,f){if(!g[e]){f||(f=h,h=[]);e=g[e]={id:e,deps:h,factory:f};if("function"===typeof e.factory){h=[];f=e.deps;for(var d=0,l=f.length;d<l;d++)h.push(b(f[d]));e.exports=e.factory.apply(a,h)}else e.exports=e.factory;delete e.factory}},b=function(e){return(e=g[e])?e.exports:null};a.version="0.1";a.cache={kernel:g};a("global",d);a("require",function(){return b});d.lofty=a}})(this);
lofty("lang",function(){var d={}.toString,g=Array.prototype,a={isFunction:function(b){return"[object Function]"===d.call(b)},isArray:Array.isArray||function(b){return"[object Array]"===d.call(b)},isString:function(b){return"string"===typeof b},forEach:g.forEach?function(b,e,h){b.forEach(e,h)}:function(b,e,h){for(var f=0,a=b.length;f<a;f++)e.call(h,b[f],f,b)},map:g.map?function(b,e,a){return b.map(e,a)}:function(b,e,h){var f=[];a.forEach(b,function(b,a,m){f.push(e.call(h,b,a,m))});return f},indexOf:g.indexOf?
function(b,e){return b.indexOf(e)}:function(b,e){for(var a=0,f=b.length;a<f;a++)if(b[a]===e)return a;return-1}};return a});lofty("event",function(){var d=this.cache.events={},g=[].slice;return{on:function(a,b){(d[a]||(d[a]=[])).push(b)},emit:function(a){var b=g.call(arguments,1),e=d[a],h,f=0;if(e)for(;h=e[f++];)h.apply(null,b)}}});
lofty("config",["lang"],function(d){var g=this.cache,a=g.config={},b=g.configRules={},g={addRule:function(e,a){b[e]={rule:a,keys:[]};return this},addRuleKey:function(a,d){b[d]&&b[d].keys.push(a);return this}};g.addRule("object",function(a,b,f){if(a){for(var d in f)a[d]=f[d];return!0}return!1}).addRule("array",function(a,b,f){a?a.push(f):this[b]=[f];return!0});this.config=function(e){for(var h in e){var f=e[h],g=a[h],l=h,m=f,j=!1,c=void 0,n=void 0;for(n in b)if(j)break;else c=b[n],j=-1<d.indexOf(c.keys,
l)&&c.rule.call(a,g,l,m);j||(a[h]=f)}};return g});lofty("alias",["config","event"],function(d,g){var a=this.cache.config;d.addRuleKey("alias","object");return function(b){var e=a.alias,d;if(e&&(d=e[b.id]))b.id=d;g.emit("alias",b)}});
lofty("module",["global","lang","event","alias"],function(d,g,a,b){var e=[],h=0,f=this.cache.modules={},k={get:function(c){c={id:c};b(c);return f[c.id]},has:function(c){return k.get(c)||m[c]?!0:!1},hasDefine:function(c){return f[c]?!0:!1},isAnon:function(c){return""===c.id},save:function(c){f[c._id||c.id]=c},autocompile:function(c){k.isAnon(c)&&k.compile(c)},compile:function(c){try{if(g.isFunction(c.factory)){var b=[],e=c.deps;g.isArray(e)&&g.forEach(e,function(a){var e;a=(e=m[a])?e(c):k.require(a,
c);b.push(a)});var f=c.factory.apply(null,b);void 0!==f?c.exports=f:c.entity&&(c.exports=c.entity.exports);c.entity&&delete c.entity}else void 0!==c.factory&&(c.exports=c.factory);a.emit("compiled",c)}catch(d){a.emit("compileFail",d,c)}},require:function(c){var b=k.get(c);b?(b.visits||(b.visits++,k.compile(b)),a.emit("required",b),c=b.exports):(a.emit("requireFail",{id:c}),c=null);return c}},l=function(c,a,b){this.id=c;this.deps=a||[];this.factory=b;this.exports={};this.visits=0;""===c&&(c="__!_lofty_anonymous_"+
h,h++,this._id=c)},m={require:function(){function c(c){return k.require(c)}a.emit("makeRequire",c);return c},exports:function(c){return c.exports},module:function(c){c.entity={id:c.id,exports:c.exports};return c.entity}},j=d.define;this.noConflict=function(){d.define=j};this.define=function(c,b,f){var d;d=arguments.length;1===d?(f=c,c=""):2===d&&(f=b,b=e,g.isString(c)||(b=c,c=""));if(k.hasDefine(c))return a.emit("existed",{id:c}),null;d=new l(c,b,f);a.emit("define",d);k.save(d);k.autocompile(d)};
d.define=this.define;return k});
lofty("loader",["global"],function(d){var g=this.cache.config,a=d.document,b=/\.css(?:\?|$)/,e=/loaded|complete|undefined/,h=536>1*d.navigator.userAgent.replace(/.*AppleWebKit\/(\d+)\..*/,"$1"),f=a&&(a.head||a.getElementsByTagName("head")[0]||a.documentElement),k=a.getElementsByTagName("base")[0],l=function(a,b){a.onerror=function(){a.onload=a.onreadystatechange=a.onerror=null;a=void 0;b&&b()}};return function(m,j){var c;if(b.test(m)){var n=c=a.createElement("link");if(h||!("onload"in n)){var q=a.createElement("img");
q.onerror=function(){j();q.onerror=null;q=void 0};q.src=m}else n.onload=n.onreadystatechange=function(){e.test(n.readyState)&&(n.onload=n.onreadystatechange=n.onerror=null,n=void 0,j&&j())},l(n,j);c.rel="stylesheet";c.href=m}else{var p=c=a.createElement("script");p.onload=p.onreadystatechange=function(c){c=c||d.event;if("load"===c.type||e.test(p.readyState))p.onload=p.onreadystatechange=p.onerror=null,g.debug||f.removeChild(p),p=void 0,j&&j()};l(p,j);c.async=!0;c.src=m}g.charset&&(c.charset=g.charset);
k?f.insertBefore(c,k):f.appendChild(c)}});
lofty("id2url",["global","event","config","alias"],function(d,g,a,b){var e=this.cache.config,h=/\?|\.(?:css|js)$|\/$/,f=/^https?:\/\//,k=(new Date).getTime();d=d.document.getElementsByTagName("script");d=d[d.length-1];d=(d.hasAttribute?d.src:d.getAttribute("src",4)).match(/([\w]+)\:\/\/([\w|\.|\:]+)\//i);e.baseUrl=d[0];a.addRuleKey("resolve","array").addRuleKey("stamp","object");return function(a){b(a);var d=e.resolve,j;if(d)for(var c=0,n=d.length;c<n&&!(j=d[c](a.id),j!==a.id);c++);a.url=j?j:a.id;
f.test(a.url)||(a.url=e.baseUrl+a.url);!h.test(a.url)&&(a.url+=".js");d=e.hasStamp?k:null;(j=e.stamp)&&j[a.id]&&(d=j[a.id]);d&&(a.url+="?lofty.stamp="+d);g.emit("id2url",a)}});
lofty("request",["global","event","loader","id2url"],function(d,g,a,b){var e=this.cache,h=e.config,f=e.assets={};h.loadTimeout=1E4;var k=function(a,b){if(!a.timeout){d.clearTimeout(a.timer);var f,c;b?(a.status=2,c=a.callQueue):(a.status=-1,c=a.errorQueue);for(;f=c.shift();)f()}};return function(d,e,j){var c;d={id:d};b(d);c=f[d.url]||(f[d.url]=d);2===c.status?e&&e():(c.callQueue?c.callQueue.push(e):c.callQueue=[e],c.errorQueue?c.errorQueue.push(j):c.errorQueue=[j],1!==c.status&&(c.status=1,c.timer=
setTimeout(function(){c.timeout=!0;k(c,!1);g.emit("requestTimeout",c)},h.loadTimeout),a(c.url,function(){k(c,!0)})))}});
lofty("deferred",function(){var d=function(){},g=function(a){var b=this,e=[],h=0,f=0;a=a||1;var g=function(){b.then=!f?function(a){a&&a()}:function(a,b){b&&b()};g=d;l(!f?0:1);l=d;e=[]},l=function(a){for(var b,c=0;b=e[c++];)(b=b[a])&&b()};this.then=function(a,b){e.push([a,b])};this.resolve=function(){h++;h+f===a&&g()};this.reject=function(){f++;h+f===a&&g()}};return function(){for(var a=new g(arguments.length),b,d=0;b=arguments[d++];)b(a);return a}});
lofty("use",["lang","event","module","request","deferred"],function(d,g,a,b,e){var h={realize:function(b,e){d.isArray(b)||(b=[b]);h.load(b,function(){var g=d.map(b,function(b){return a.require(b)});e&&e.apply(null,g)})},load:function(b,e){var g=[];d.forEach(b,function(b){a.has(b)||g.push(b)});g.length?h.fetch(g,e):e()},fetch:function(b,g){h.get(b,function(){e.apply(null,d.map(b,function(b){return function(d){var e=a.get(b);e?h.load(e.deps,function(){d.resolve()}):d.resolve()}})).then(g)})},get:function(f,
g,h){e.apply(null,d.map(f,function(d){return function(e){a.has(d)?e.resolve():b(d,function(){e.resolve()},function(){e.reject()})}})).then(g,h)}};g.on("makeRequire",function(a){a.use=function(a,b,d){h.realize(a,b,d)}});return h});
lofty("debug",["global","config","console","request","require"],function(d,g,a,b,e){var h=this,f=this.log=function(){};g.addRule("debug",function(g,l,m){h.log=m?d.console?function(a,b){d.console[b||"log"](a)}:function(d,c){a?a(d,c):b&&b("lofty/kernel/console",function(){a||(a=e("console"));a(d,c)})}:f;this[l]=m;return!0}).addRuleKey("debug","debug")});
lofty("alicn",["global","event"],function(d,g){var a=/\.css(?:\?|$)/;this.config({hasStamp:!0,resolve:function(b){var d=b.split("/"),g=d[0],f=a.test(b)?"css/":"js/";switch(g){case "lofty":case "avid":b="/fdevlib/"+f+b;break;case "sys":b="/sys/"+f+d.slice(1).join("/")}return b},debug:function(){var a=!1;0<d.location.href.indexOf("lofty.debug=true")&&(a=!0);return a}()});this.appframe=function(a){d[a]={log:this.log,define:this.define,on:g.on}}});
